<!DOCTYPE html>
<html>
<head>
	<title>Loading Q, please wait...</title>
	<script type="text/javascript">
		var fs = require('fs');
		$ = require('jquery');
		var LocalStorage = require('node-localstorage').LocalStorage;
		var localStorage = new LocalStorage('./storage');
		var fs = require('fs');
		var mkdirp = require('mkdirp');
		var download = require('download-file');
		if(localStorage.getItem('id') == null) {
			window.location.href = "./login.html";
		}else{
			login();
		}

		localStorage.setItem("QServer", "http://anspirit.org/php");

		//login
		function login(){
		  $.ajax({
		    type: "post",
		    url: localStorage.getItem("QServer") + '/login.php',
		    data: {'email': localStorage.getItem('email'), 'password': localStorage.getItem('pass')},
		    success: function(data){
		      processLoginResult(data);
		    },
		    error: function(a, error){
		    	alert("You are not connected to the internet");
		    },
				timeout: 3000,
		    dataType: "json"
		  });
		}
		function processLoginResult(data){
		  if (!data.login) {
		    window.location.href = "./login.html";
		  }else{
		    localStorage.setItem('id', data.id);
		    localStorage.setItem('name', data.name);
		    localStorage.setItem('version', data.version);
		    localStorage.setItem('lang', data.lang);
		    localStorage.setItem('tokenCode', data.tokenCode);
		    localStorage.setItem('email', data.email);
				localStorage.setItem('country', data.country);

				downloadExtensions();
		  }
		}
		function downloadExtensions(){
			$.ajax({
				type: 'get',
				url:  localStorage.getItem("QServer") + '/userExtensions.php',
				data: {'user': localStorage.getItem('id')},
				dataType: 'json',
				success: function(extensions){
					var file = '../rules.json';
					var exts = JSON.stringify(extensions);
					console.log(exts);
					var fs = require('fs');
					fs.writeFile(file, exts, function(){
						don = true;
						localStorage.setItem('doneLoadingRules', true);
					});

					for(var i = 0; i < extensions.length; i++) {
						var url = extensions[i]['pathToExt'];
						var folderName = extensions[i]['name'];
						mkdirp('./rules/'+ folderName, function (err) {
					    if (err) console.error(err)
						});
						//Desktop.js download
						var options = {
							directory: "./rules",
							filename: folderName + "/desktop.js"
						}
						download(url + "/desktop.js", options, function(err){
						if (err) console.log("error");
							//Settings.html download
							var options = {
								directory: "./rules",
								filename: folderName + "/settings.html"
							}
							download(url + "/settings.html", options, function(err){
							if (err) console.log("error");
							//About.html download
							var options = {
									directory: "./rules",
									filename: folderName + "/about.html"
							}
							download(url + "/about.html", options, function(err){
									if (err) console.log("error");
									if(i == extensions.length){
											//$(location).attr('href','file://' + __dirname + '/userMain.html');
									}
							})
					})
			})


					}
					if(extensions.length == 0){
						$(location).attr('href','file://' + __dirname + '/userMain.html');
					}
				},
				error: function(a, error){
					console.log(error);
				}
			});
		}
	</script>
</head>
<body>
	<img src="../loading.gif" style="position: absolute; left: calc(50% - 25px); top: 300px" width="50px">
</body>
</html>
